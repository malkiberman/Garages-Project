<div class="container mat-typography">
  <h2> ניהול מוסכים</h2>
  
  <mat-card class="selection-card mat-elevation-z3">
    <mat-card-content>
      <div *ngIf="isLoadingExternal" class="spinner-container">
        <mat-spinner diameter="30"></mat-spinner>
        <p>טוען רשימת מוסכים מה-API הממשלתי...</p>
      </div>

      <mat-form-field appearance="outline" class="full-width" *ngIf="!isLoadingExternal">
        <mat-label>בחירת מוסכים להוספה</mat-label>
        <mat-select 
          [(ngModel)]="selectedGaragesCodes" 
          multiple
          placeholder="בחר מוסך או יותר לפי קוד/שם">
          <mat-option *ngFor="let garage of externalGarages" [value]="garage.misparMosah">
            {{ garage.shemMosah }} (קוד: {{ garage.misparMosah }})
          </mat-option>
        </mat-select>
      </mat-form-field>
    </mat-card-content>
    <mat-card-actions>
      <button 
        mat-raised-button 
        color="primary" 
        (click)="onAddGarages()" 
        [disabled]="isAdding || isLoadingExternal || selectedGaragesCodes.length === 0">
        <span *ngIf="!isAdding">הוספה ({{ selectedGaragesCodes.length }})</span>
        <mat-spinner *ngIf="isAdding" diameter="20" class="button-spinner"></mat-spinner>
      </button>
    </mat-card-actions>
  </mat-card>

  <mat-divider style="margin: 20px 0;"></mat-divider>

  <h3>מוסכים שמורים במערכת ({{ savedGaragesDataSource.data.length }})</h3>
  
  <div *ngIf="isLoadingSaved" class="spinner-container">
    <mat-spinner diameter="30"></mat-spinner>
    <p>טוען מוסכים שמורים...</p>
  </div>

  <mat-card class="table-card mat-elevation-z3" *ngIf="!isLoadingSaved">
  <mat-form-field appearance="outline" class="full-width filter-field">
  <mat-label>סנן לפי שם, כתובת או מקצוע</mat-label>
  <input matInput (keyup)="applyFilter($event)" placeholder="הקלד לסינון..." #input>
  <mat-icon matSuffix>search</mat-icon>
</mat-form-field>
    
    <table 
      mat-table 
      [dataSource]="savedGaragesDataSource" 
      class="full-width">

      <ng-container matColumnDef="misparMosah">
        <th mat-header-cell *matHeaderCellDef> קוד מוסך </th>
        <td mat-cell *matCellDef="let element"> {{element.misparMosah}} </td>
      </ng-container>

      <ng-container matColumnDef="shemMosah">
        <th mat-header-cell *matHeaderCellDef> שם מוסך </th>
        <td mat-cell *matCellDef="let element"> **{{element.shemMosah}}** </td>
      </ng-container>

      <ng-container matColumnDef="ktovet">
        <th mat-header-cell *matHeaderCellDef> כתובת </th>
        <td mat-cell *matCellDef="let element"> {{element.ktovet}}, {{element.yishuv}} </td>
      </ng-container>
      
      <ng-container matColumnDef="miktzoa">
        <th mat-header-cell *matHeaderCellDef> מקצוע ראשי </th>
        <td mat-cell *matCellDef="let element"> {{element.miktzoa}} </td>
      </ng-container>
      
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" ></tr>
    </table>

    <div *ngIf="savedGaragesDataSource.data.length === 0 && !isLoadingSaved" class="no-data">
      <p>הטבלה ריקה. נא להוסיף מוסכים מרשימת הבחירה למעלה.</p>
    </div>
  </mat-card>
</div>